<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>Cachingmysql by ianjjohnson</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name">Cachingmysql</h1>
      <h2 class="project-tagline">A small query caching example in PHP with MySQL</h2>
      <a href="https://github.com/ianjjohnson/CachingMySQL" class="btn">View on GitHub</a>
      <a href="https://github.com/ianjjohnson/CachingMySQL/zipball/master" class="btn">Download .zip</a>
      <a href="https://github.com/ianjjohnson/CachingMySQL/tarball/master" class="btn">Download .tar.gz</a>
    </section>

    <section class="main-content">
      <h1>
<a id="why-cache-sql-queries" class="anchor" href="#why-cache-sql-queries" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Why Cache SQL Queries?</h1>

<p>Some SQL queries, as you've likely discovered, are expensive to execute. Complex queries of large databases, even when optimized, can take a significant amount of time -- so much so that it can inhibit pleasant UX. By caching complex queries which occur often, we can optimize-away the long wait times associated with those expensive SQL queries which occur the most often.</p>

<h1>
<a id="how-can-i-cache-sql-queries" class="anchor" href="#how-can-i-cache-sql-queries" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>How Can I Cache SQL Queries?</h1>

<p>SQL queries can be cached in one of two ways -- they can be cached SQL-server side, or 'locally' inside the PHP script which is querying the database. </p>

<h3>
<a id="caching-on-the-sql-server" class="anchor" href="#caching-on-the-sql-server" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Caching on the SQL server</h3>

<p>The first method is to have your SQL database cache the query internally using SQL 'hints' inside of database queries. 
This can be achieved using the <code>MYSQLND_QC_ENABLE_SWITCH</code> hint, which, when wrapped inside an SQL query, tells the DBMS to save the output of that query for future use.</p>

<pre><code>//The MYSQLND_QC_ENABLE_SWITCH flag at the start of the query tells SQL to cache the result.
$select = $db-&gt;query("/*" . MYSQLND_QC_ENABLE_SWITCH . "*/" . "SELECT * FROM table");
</code></pre>

<p>Subsequent queries to the database with the same query meaning (e.g. anything which provides the same functionality as 'select * from table' in this case) will return the cached result from the SQL server unless something has changed on the server side.</p>

<h3>
<a id="caching-in-the-php-environment" class="anchor" href="#caching-in-the-php-environment" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Caching in the PHP environment</h3>

<p>The second method is to save the results of a SQL query inside an associative array in the cache of a PHP process. This can be achieved using a library called <code>Memcached</code> which allows a PHP user to store data in local cache.</p>

<pre><code>$cache = new Memcached(); //Build a new memcached object
$cache-&gt;addServer('localhost', 11211); //11211 should always be the second parameter
$key = 'some SQL query'; //This is the key for a key-value pair in the cache object
$result = $cache-&gt;get($key); //See if there's data for this query in the cache
//If there's nothing in the cache, we need to query the SQL server
if (!$result) {

    //Execute the query on SQL server
    $select = db-&gt;query("SELECT first_name FROM employee where last_name = 'bob'"); 
    $result = $select-&gt;fetchAll(PDO::FETCH_OBJ); //Fetch result 
    $cache-&gt;set($key, serialize($row)); //Load the result into the cache

}
</code></pre>

<p>Unlike SQL-side caching, this caching approach assumes that no changes have been made to the database since the last time the query was cached. This can be a dangerous assumption. Use this carefully!</p>

<h3>
<a id="cool-now-show-me-the-code" class="anchor" href="#cool-now-show-me-the-code" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Cool. Now show me the code!</h3>

<p>Check out this repository to see a simple example of both SQL-side caching and PHP-side caching!</p>

<h3>
<a id="sql-side-troubles" class="anchor" href="#sql-side-troubles" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>SQL-Side troubles?</h3>

<p>Some SQL servers don't default to allowing server-side caching. For an in-depth exploration of the SQL server-side settings caching, check out <a href="http://www.howtogeek.com/howto/programming/speed-up-your-web-site-with-mysql-query-caching/">this page</a></p>

<h2>
<a id="a-third-approach" class="anchor" href="#a-third-approach" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>A Third Approach</h2>

<p>SQL can also cache queries server-side using a slightly more sophisticated rule-based methodology. In PHP this is done using <code>mysqlnd_set_cache_condition()</code>. We won't get into that here, but you can read more <a href="http://php.net/manual/en/function.mysqlnd-qc-set-cache-condition.php">here</a></p>

<h2>
<a id="further-reference" class="anchor" href="#further-reference" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Further Reference</h2>

<p>Visit <a href="http://php.net/manual/en/mysqlnd-qc.quickstart.caching.php">the PHP documentation</a> for more information about SQL caching.</p>

      <footer class="site-footer">
        <span class="site-footer-owner"><a href="https://github.com/ianjjohnson/CachingMySQL">Cachingmysql</a> is maintained by <a href="https://github.com/ianjjohnson">ianjjohnson</a>.</span>

        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a> by <a href="https://twitter.com/jasonlong">Jason Long</a>.</span>
      </footer>

    </section>

  
  </body>
</html>
